name: Publish Docker Hub

on:
  push:
    branches:
      - main
      - dev
      - 'dev-*'
    tags:
      - '*'
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      DOCKERHUB_USER: ${{ vars.DOCKERHUB_USER }}
      DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
      DOCKERHUB_IMAGE: ${{ vars.DOCKERHUB_IMAGE }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate configuration
        run: |
          set -euo pipefail
          for var in DOCKERHUB_USER DOCKERHUB_PASSWORD DOCKERHUB_IMAGE; do
            if [ -z "${!var}" ]; then
              echo "Missing value for $var" >&2
              exit 1
            fi
          done

      - name: Determine tags
        id: tags
        run: |
          set -euo pipefail
          ref="${GITHUB_REF}"
          ref_name="${GITHUB_REF_NAME}"
          sha_short="$(printf '%s' "${GITHUB_SHA}" | cut -c1-7)"
          if [[ "${ref}" == refs/tags/* ]]; then
            suffix="${ref#refs/tags/}"
          elif [[ "${ref_name}" == "main" ]]; then
            suffix="latest"
          else
            slug="$(printf '%s' "${ref_name}" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9]+/-/g' | sed -E 's/^-+|-+$//g')"
            [[ -z "${slug}" ]] && slug="sha-${sha_short}"
            suffix="${slug}"
          fi
          base_tag="docker.io/${DOCKERHUB_IMAGE}:${suffix}"
          echo "BASE_TAG=${base_tag}" >> "${GITHUB_ENV}"
          echo "AMD64_TAG=${base_tag}-amd64" >> "${GITHUB_ENV}"
          echo "ARM64_TAG=${base_tag}-arm64" >> "${GITHUB_ENV}"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USER }}
          password: ${{ env.DOCKERHUB_PASSWORD }}

      - name: Build and push linux/amd64 image
        env:
          BASE_TAG: ${{ env.BASE_TAG }}
          AMD64_TAG: ${{ env.AMD64_TAG }}
        run: |
          set -euo pipefail
          docker buildx build \
            --platform linux/amd64 \
            --file .build/Dockerfile \
            --push \
            --tag "${AMD64_TAG}" \
            --tag "${BASE_TAG}" \
            .

      - name: Build and push linux/arm64 image
        env:
          ARM64_TAG: ${{ env.ARM64_TAG }}
        run: |
          set -euo pipefail
          docker buildx build \
            --platform linux/arm64 \
            --file .build/Dockerfile \
            --push \
            --tag "${ARM64_TAG}" \
            .
